/*
* ajax.js by Meiguro - MIT License
*/

var ajax = (function(){
          
          var formify = function(data) {
          var params = [], i = 0;
          for (var name in data) {
          params[i++] = encodeURI(name) + '=' + encodeURI(data[name]);
          }
          return params.join('&');
          };
          
/**
* ajax options. There are various properties with url being the only required property.
* @typedef ajaxOptions
* @property {string} [method='get'] - The HTTP method to use: 'get', 'post', 'put', 'delete', 'options',
*    or any other standard method supported by the running environment.
* @property {string} url - The URL to make the ajax request to. e.g. 'http://www.example.com?name=value'
* @property {string} [type='text'] - The expected response format. Specify 'json' to have ajax parse
*    the response as json and pass an object as the data parameter.
* @property {object} [data] - The request body, mainly to be used in combination with 'post' or 'put'.
*    e.g. { username: 'guest' }
* @property {object} headers - Custom HTTP headers. Specify additional headers.
*    e.g. { 'x-extra': 'Extra Header' }
* @property {boolean} [async=true] - Whether the request will be asynchronous.
*    Specify false for a blocking, synchronous request.
* @property {boolean} [cache=true] - Whether the result may be cached.
*    Specify false to use the internal cache buster which appends the URL with the query parameter _
*    set to the current time in milliseconds.
*/
          
/**
* ajax
* @global
* @param {ajaxOptions} opt - Options specifying the type of ajax request to make.
* @param {function} success - The success handler that is called when a HTTP 200 response is given.
* @param {function} failure - The failure handler when the HTTP request fails or is not 200.
*/
          var ajax = function(opt, success, failure) {
          var method = opt.method || 'GET';
          var url = opt.url;
          //console.log(method + ' ' + url);
          
          var onHandler = ajax.onHandler;
          if (onHandler) {
          if (success) { success = onHandler('success', success); }
          if (failure) { failure = onHandler('failure', failure); }
          }
          
          var req = new XMLHttpRequest();
          req.open(method.toUpperCase(), url, opt.async !== false);
          
          var headers = opt.headers;
          if (headers) {
          for (var name in headers) {
          req.setRequestHeader(name, headers[name]);
          }
          }
          
          var data = null;
          if (opt.data) {
          if (opt.type === 'json') {
          req.setRequestHeader('Content-Type', 'application/json');
          data = JSON.stringify(opt.data);
          } else {
          data = formify(opt.data);
          }
          }
          
          if (opt.cache === false) {
          var appendSymbol = url.indexOf('?') === -1 ? '?' : '&';
          url += appendSymbol + '_=' + new Date().getTime();
          }
          
          req.onreadystatechange = function(e) {
          if (req.readyState == 4) {
          var body = req.responseText;
          if (opt.type == 'json') {
          body = JSON.parse(body);
          }
          var callback = req.status == 200 ? success : failure;
          if (callback) {
          callback(body, req.status, req);
          }
          }
          };
          
          req.send(data);
          };
          
          ajax.formify = formify;
          
          return ajax;
          
          })();